<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ØªÙ…Ø§Ù…Ø§Ù‹ */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');

        :root {
            --bg-color: #ffffff;
            --text-color: #2d3436;
            --orange-color: #ff7f30;
            --blue-color: #2962ff;
            --gray-icon: #9e9e9e;
            --gray-light: #f5f6fa;
            --grid-line: #f2f2f2;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Tajawal', sans-serif;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            color: var(--text-color);
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        /* --- Header --- */
        .top-header {
            background-color: #ffffff;
            height: 70px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            padding-top: 15px; 
            flex-shrink: 0;
            direction: ltr; 
            z-index: 100;
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .nav-icon:active { transform: scale(0.9); }
        .nav-icon svg { width: 28px; height: 28px; }

        /* --- Tools Menu --- */
        .tools-bar {
            background: #ffffff;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border-bottom: 1px solid #f0f0f0;
            position: absolute;
            top: 70px; 
            width: 100%;
            z-index: 99;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            direction: rtl;
        }

        .tool-box {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            height: 80px;
            border: 2px solid transparent;
            user-select: none;
        }
        .tool-box.active { border-color: var(--blue-color); background: #e3f2fd; }
        .tool-icon-img { font-size: 1.8rem; margin-bottom: 5px; }
        .tool-name { font-size: 0.75rem; font-weight: bold; color: #555; text-align: center;}

        /* --- Display Area --- */
        .display-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 5px 25px 10px 25px;
            background: #ffffff;
            overflow: hidden;
            min-height: 0;
        }

        .result-line {
            text-align: right;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; 
            max-height: 25%;
            overflow: visible;
        }
        
        .main-res { 
            font-size: 2.4rem; 
            font-weight: 800; 
            color: #2d3436; 
            direction: ltr; 
            word-wrap: break-word; 
            line-height: 1.2; 
            transition: font-size 0.2s ease;
        }
        .sub-res { 
            font-size: 1.3rem; 
            color: #b2bec3; 
            direction: ltr; 
            margin-top: 2px; 
            font-weight: 500;
            transition: font-size 0.2s ease;
            word-wrap: break-word; 
            line-height: 1.1;
        }

        .result-line.final-state .main-res { color: var(--blue-color); }
        .result-line.final-state .sub-res { color: #636e72; font-weight: 700; }

        .inputs-wrapper {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            direction: rtl; 
            flex-shrink: 0; 
        }

        .curr-box {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid transparent; 
            background: var(--gray-light);
            border-radius: 12px;
            text-align: right;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 70px;
            justify-content: center;
        }
        .curr-box.active { 
            border-color: var(--blue-color); 
            background: #fff; 
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.1); 
        }

        .currency-toggle-btn {
            font-size: 0.85rem;
            color: var(--blue-color);
            font-weight: 800;
            margin-bottom: 5px;
            cursor: pointer;
            user-select: none;
            display: inline-block;
            background: rgba(41, 98, 255, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            width: fit-content;
        }
        .currency-toggle-btn:active { transform: scale(0.95); }

        .curr-label { font-size: 0.75rem; color: #636e72; font-weight: bold; margin-bottom: 2px; user-select: none;}

        .curr-val-input {
            font-size: 1.7rem; 
            font-weight: 700; 
            direction: ltr; 
            color: #2d3436;
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            font-family: 'Tajawal', sans-serif;
            padding: 0;
            margin: 0;
            caret-color: var(--blue-color);
            letter-spacing: 0.5px;
        }
        .curr-val-input::placeholder { color: #ccc; }

        /* --- Keypad --- */
        .middle-toolbar {
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            background: #ffffff;
            flex-shrink: 0;
            direction: ltr; 
            border-bottom: 1px solid var(--grid-line);
        }

        .backspace-btn {
            color: var(--orange-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            user-select: none;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background-color: #ffffff;
            height: 55%; 
            flex-shrink: 0;
            direction: ltr; 
            padding-bottom: 5px;
        }

        .k-btn {
            background: #ffffff;
            border: none;
            border-right: 1px solid var(--grid-line);
            border-top: 1px solid var(--grid-line);
            font-size: 1.8rem;
            color: #2d3436;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            outline: none;
            transition: background 0.1s;
            user-select: none;
        }
        .k-btn:nth-child(4n) { border-right: none; }
        .k-btn.pressed { background-color: #f7f7f7; }
        
        .txt-blue { color: var(--blue-color); font-weight: 500; font-size: 1.6rem;}
        .bg-blue { 
            background-color: var(--orange-color) !important; 
            color: white; 
            font-size: 2.2rem; 
            border-radius: 12px;
            margin: 5px; 
            height: auto;
            border: none;
            box-shadow: 0 4px 10px rgba(255, 159, 67, 0.3);
        }
        .bg-blue.pressed { transform: scale(0.95); opacity: 0.9; }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(4px); direction: rtl; 
        }
        .modal.show { display: flex; }
        .modal-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 20px; padding: 20px; max-height: 70vh;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .rate-group input {
            width: 100%; border: none; background: #f5f6fa; padding: 15px;
            font-size: 1.4rem; margin: 15px 0; text-align: center;
            border-radius: 12px; color: var(--orange-color); font-weight: 800; outline: none;
        }
        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; padding-top:10px;}
        .history-item { 
            padding: 12px; border-bottom: 1px solid #f5f5f5; 
            display: flex; justify-content: space-between; align-items: center;
        }

        .age-result-container {
            display: flex; gap: 8px; justify-content: center; width: 100%; direction: rtl;
        }
        .age-box-res {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;
            padding: 5px; text-align: center; flex: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .age-num { font-size: 1.3rem; font-weight: 800; color: var(--blue-color); display: block;}
        .age-txt { font-size: 0.75rem; color: #888; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="top-header">
            <div class="nav-icon" id="btnRate">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gray-icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9.5L12 3l9 6.5v10.5a2 2 0 0 1-2 2h-14a2 2 0 0 1-2-2z"></path>
                    <text x="12" y="18" text-anchor="middle" font-size="12" fill="var(--gray-icon)" stroke="none" font-weight="bold">$</text>
                </svg>
            </div>
            <div class="nav-icon" id="btnGrid">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--gray-icon)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7" rx="2"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="2"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="2"></rect>
                    <line x1="14" y1="16" x2="21" y2="16"></line>
                    <line x1="14" y1="19" x2="21" y2="19"></line>
                </svg>
            </div>
            <div class="nav-icon" id="btnHome">
                <svg viewBox="0 0 24 24" fill="none">
                    <rect x="0" y="0" width="24" height="24" rx="8" fill="#ff7f30"></rect>
                    <line x1="7" y1="10" x2="17" y2="10" stroke="white" stroke-width="2.5" stroke-linecap="round"></line>
                    <line x1="7" y1="14" x2="17" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round"></line>
                </svg>
            </div>
        </div>

        <div class="tools-bar" id="toolsMenu">
            <div class="tool-box" id="toolAge">
                <span class="tool-icon-img">ğŸ‚</span>
                <span class="tool-name">Ø§Ù„Ø¹Ù…Ø±</span>
            </div>
            <div class="tool-box" id="toolDiff">
                <span class="tool-icon-img">ğŸ“…</span>
                <span class="tool-name">ÙØ±Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</span>
            </div>
            <div class="tool-box" id="toolScale">
                <span class="tool-icon-img">âš–ï¸</span>
                <span class="tool-name">Ø§Ù„Ù…ÙŠØ²Ø§Ù†</span>
            </div>
            <div class="tool-box" id="toolSpeed">
                <span class="tool-icon-img">ğŸš—</span>
                <span class="tool-name">Ø§Ù„Ø³Ø±Ø¹Ø©</span>
            </div>
            <div class="tool-box" id="toolHistory">
                <span class="tool-icon-img">ğŸ•’</span>
                <span class="tool-name">Ø§Ù„Ø³Ø¬Ù„</span>
            </div>
        </div>

        <div class="display-area">
            <div class="result-line" id="resultContainer">
                <div class="main-res" id="mainResult">0</div>
                <div class="sub-res" id="subResult"></div>
            </div>

            <div class="inputs-wrapper" id="inputsContainer">
                <div class="curr-box active" id="box1">
                    <div class="currency-toggle-btn" id="currencyToggleBtn">Ù„ÙŠØ±Ø©</div>
                    <div class="curr-label" id="label1" style="display:none">Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
                    <input type="text" class="curr-val-input" id="val1" inputmode="none" placeholder="0">
                </div>
                <div class="curr-box" id="box2" style="display:none">
                    <div class="curr-label" id="label2">---</div>
                    <input type="text" class="curr-val-input" id="val2" inputmode="none" placeholder="0">
                </div>
                <div class="curr-box" id="box3" style="display:none">
                    <div class="curr-label" id="label3">Ø³Ù†Ø©</div>
                    <input type="text" class="curr-val-input" id="val3" inputmode="none" placeholder="0000">
                </div>
            </div>
        </div>

        <div class="middle-toolbar">
            <div></div> 
            <div class="backspace-btn" id="btnBackspace">âŒ«</div>
        </div>

        <div class="keypad">
            <button class="k-btn txt-blue" data-action="clear">C</button>
            <button class="k-btn txt-blue" data-action="parens">()</button>
            <button class="k-btn txt-blue" data-val="%">%</button>
            <button class="k-btn txt-blue" data-val="/">Ã·</button>

            <button class="k-btn" data-val="7">7</button>
            <button class="k-btn" data-val="8">8</button>
            <button class="k-btn" data-val="9">9</button>
            <button class="k-btn txt-blue" data-val="*">Ã—</button>

            <button class="k-btn" data-val="4">4</button>
            <button class="k-btn" data-val="5">5</button>
            <button class="k-btn" data-val="6">6</button>
            <button class="k-btn txt-blue" data-val="-">-</button>

            <button class="k-btn" data-val="1">1</button>
            <button class="k-btn" data-val="2">2</button>
            <button class="k-btn" data-val="3">3</button>
            <button class="k-btn txt-blue" data-val="+">+</button>

            <button class="k-btn" data-val="0">0</button>
            <button class="k-btn" data-val="00">00</button>
            <button class="k-btn" data-val=".">,</button>
            <button class="k-btn bg-blue" id="btnEqual" data-action="calc">=</button>
        </div>

    </div>

    <div id="historyModal" class="modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:1.2rem">Ø§Ù„Ø³Ø¬Ù„</span>
                <span id="btnCloseHist" style="cursor:pointer; font-size:1.5rem">âœ•</span>
            </div>
            <div style="text-align:left; margin-bottom:10px;">
                <span style="color:red; font-size:0.9rem; cursor:pointer" id="btnClearHistory">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</span>
            </div>
            <ul id="historyList" class="history-list"></ul>
        </div>
    </div>

    <div id="rateModal" class="modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:1.2rem">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</span>
                <span id="btnCloseRate" style="cursor:pointer; font-size:1.5rem">âœ•</span>
            </div>
            <div class="rate-group">
                <input type="number" id="exchangeRate" value="89000" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±">
            </div>
            <button class="k-btn" style="width:100%; border-radius:12px; background:var(--orange-color); color:white; border:none;" id="btnSaveRate">Ø­ÙØ¸</button>
        </div>
    </div>

    <script>
        /**
         * PROFESSIONAL CALCULATOR ENGINE
         * UPDATED: Fixed Implicit Multiplication after % (e.g. 400000%83 -> 400000%*83)
         */

        let appMode = 'calc'; 
        let activeInputId = 'val1'; 
        let activeCalcCurr = 'LBP'; 

        // Calculation State
        let diffStep = 1; 
        let diffStart = null;
        let timeUnit = 'sec';
        let isFinalState = false;
        
        // Repeated Equals Logic
        let lastRepeatedOp = null;
        let lastResultValue = 0;

        let historyData = [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- Sound & Initialization ---
        function playSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(600, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.04);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.05);
        }

        window.onload = () => { 
            loadState(); 
            resetTempData();
            setupFastClicks();
            document.querySelectorAll('.curr-val-input').forEach(inp => {
                inp.addEventListener('click', () => setActiveInput(inp.id));
            });
            updateUI(false); 
        };

        function resetTempData() {
            appMode = 'calc';
            diffStep = 1; diffStart = null;
            timeUnit = 'sec';
            isFinalState = false;
            lastRepeatedOp = null;
        }

        // --- Core Input Logic ---
        function setActiveInput(id) {
            activeInputId = id;
            document.querySelectorAll('.curr-box').forEach(b => b.classList.remove('active'));
            document.getElementById(id).parentElement.classList.add('active');
        }

        function setupFastClicks() {
            document.querySelectorAll('.k-btn').forEach(btn => {
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); btn.classList.add('pressed'); handleInput(btn); }, {passive: false});
                btn.addEventListener('touchend', (e) => { e.preventDefault(); btn.classList.remove('pressed'); });
                btn.addEventListener('mousedown', (e) => { e.preventDefault(); btn.classList.add('pressed'); handleInput(btn); }); 
                btn.addEventListener('mouseup', () => btn.classList.remove('pressed'));
                btn.addEventListener('mouseleave', () => btn.classList.remove('pressed'));
            });

            // Fast Events Helpers
            const bind = (id, fn) => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('touchstart', (e) => { e.preventDefault(); e.stopPropagation(); fn(); }, {passive: false});
                    el.addEventListener('click', (e) => { e.stopPropagation(); fn(); });
                }
            };

            bind('btnRate', openRate);
            bind('btnGrid', toggleTools);
            bind('btnHome', () => switchMode('calc'));
            bind('toolAge', () => switchMode('age'));
            bind('toolDiff', () => switchMode('diff'));
            bind('toolScale', () => switchMode('scale'));
            bind('toolSpeed', () => switchMode('speed'));
            bind('toolHistory', openHistory); 
            bind('btnCloseHist', closeModals);
            bind('btnCloseRate', closeModals);
            bind('btnSaveRate', closeModals);
            bind('btnClearHistory', clearHistory);
            bind('btnBackspace', deleteChar);
            bind('currencyToggleBtn', toggleCurrency);

            document.getElementById('box1').onclick = () => { setActiveInput('val1'); document.getElementById('val1').focus(); };
            document.getElementById('box2').onclick = () => { setActiveInput('val2'); document.getElementById('val2').focus(); };
            document.getElementById('box3').onclick = () => { setActiveInput('val3'); document.getElementById('val3').focus(); };
            document.getElementById('label2').onclick = () => { if(appMode === 'speed') toggleTimeUnit(); };
        }

        function toggleCurrency() {
            if(appMode !== 'calc') return;
            const btn = document.getElementById('currencyToggleBtn');
            if(activeCalcCurr === 'LBP') {
                activeCalcCurr = 'USD';
                btn.innerText = 'Ø¯ÙˆÙ„Ø§Ø± ($)';
            } else {
                activeCalcCurr = 'LBP';
                btn.innerText = 'Ù„ÙŠØ±Ø© (L.L)';
            }
            calculate(false);
        }

        function toggleTimeUnit() {
            timeUnit = (timeUnit === 'sec') ? 'min' : (timeUnit === 'min') ? 'hour' : 'sec';
            updateUI();
        }

        // --- Input Handling ---
        function handleInput(btn) {
            playSound();
            const val = btn.getAttribute('data-val');
            const action = btn.getAttribute('data-action');
            
            if(isFinalState) {
                if (val && !['+','-','*','/','%'].includes(val)) {
                    clearAll(false);
                } else if (['+','-','*','/','%'].includes(val)) {
                    document.getElementById('val1').value = formatString(lastResultValue.toString());
                    isFinalState = false;
                    document.getElementById('resultContainer').classList.remove('final-state');
                } else {
                    isFinalState = false;
                    document.getElementById('resultContainer').classList.remove('final-state');
                }
            }

            if (val) insertChar(val);
            else if (action) {
                if(action === 'clear') clearAll();
                else if(action === 'parens') { if (appMode === 'calc') insertParens(); }
                else if(action === 'calc') calculate(true);
            }
        }

        function cleanString(str) {
            if(!str) return '';
            return str.replace(/,/g, '').replace(/Ã—/g, '*').replace(/Ã·/g, '/');
        }

        function formatString(str) {
            if(!str) return '';
            let visual = str.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·');
            return visual.replace(/(\d+)(\.\d*)?/g, (match, p1, p2) => {
                return p1.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (p2 || "");
            });
        }

        function insertChar(char) {
            const input = document.getElementById(activeInputId);
            if(!input) return;

            let val = input.value;
            let rawVal = cleanString(val);
            const operators = ['+','-','*','/','%'];
            const lastChar = rawVal.slice(-1);

            // 1. Operator replacement logic
            if (operators.includes(char) && operators.includes(lastChar) && appMode === 'calc') {
                val = val.slice(0, -1); 
            }

            // 2. Decimal logic
            if (char === '.') {
                const parts = rawVal.split(/[\+\-\*\/\%]/);
                const currentNumber = parts[parts.length - 1];
                if (currentNumber.includes('.')) return; 
                if (currentNumber === '') char = '0.'; 
            }

            // 3. IMPLICIT MULTIPLICATION AFTER % (Fix for User)
            // If previous char was %, and user types a number, insert * automatically
            if (lastChar === '%' && !operators.includes(char) && char !== '.') {
                char = '*' + char;
            }

            let newRaw = cleanString(val) + char;
            input.value = (appMode === 'calc' || appMode === 'scale') ? formatString(newRaw) : newRaw;
            
            if(appMode === 'calc') calculate(false);
            else updateUI(true);
        }

        function insertParens() {
            insertChar('('); 
        }

        function deleteChar() {
            playSound();
            const input = document.getElementById(activeInputId);
            let val = input.value;
            if(isFinalState) {
                isFinalState = false;
                document.getElementById('resultContainer').classList.remove('final-state');
            }
            let raw = cleanString(val);
            let newRaw = raw.substring(0, raw.length - 1);
            input.value = formatString(newRaw);
            
            if(appMode === 'calc') calculate(false);
            else updateUI(true);
        }

        function clearAll(fullReset = true) {
            playSound();
            ['val1', 'val2', 'val3'].forEach(id => document.getElementById(id).value = '');
            if(fullReset) {
                if(appMode === 'diff') { diffStep = 1; diffStart = null; setActiveInput('val1'); }
                if(appMode === 'age') setActiveInput('val1');
                lastRepeatedOp = null;
            }
            isFinalState = false;
            document.getElementById('resultContainer').classList.remove('final-state');
            document.getElementById('mainResult').innerText = '0';
            document.getElementById('subResult').innerText = '';
        }

        // --- SEQUENTIAL MATH LOGIC (Left-To-Right) ---
        
        function computeSequential(expr) {
            try {
                // 1. ØªÙÙƒÙŠÙƒ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙˆØ¹Ù…Ù„ÙŠØ§Øª
                // Ù†Ø³ØªØ®Ø¯Ù… Regex Ù„ÙØµÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                let tokens = expr.match(/(\d+(\.\d+)?)|([\+\-\*\/\%\(\)])/g);
                if (!tokens) return 0;

                // 2. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (Merchant Logic)
                // Ø§Ù„Ù‡Ø¯Ù: ØªØ­ÙˆÙŠÙ„ "100 - 10%" Ø¥Ù„Ù‰ "100 - 10" (Ø£ÙŠ Ø®ØµÙ… 10)
                let processedTokens = [];
                
                for (let i = 0; i < tokens.length; i++) {
                    if (tokens[i] === '%') {
                        // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„ Ø¹Ù„Ø§Ù…Ø© %
                        let currentVal = parseFloat(processedTokens.pop()); 
                        
                        // Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙŠ Ø³Ø¨Ù‚Øª Ø§Ù„Ø±Ù‚Ù… (Ù…Ø«Ù„Ø§Ù‹ + Ø£Ùˆ -)
                        let prevOp = processedTokens.length > 0 ? processedTokens[processedTokens.length - 1] : null;
                        
                        // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø°ÙŠ Ø³Ù†Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù†Ù‡ (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ)
                        let baseNumber = processedTokens.length > 1 ? parseFloat(processedTokens[processedTokens.length - 2]) : 0;

                        if ((prevOp === '+' || prevOp === '-') && !isNaN(baseNumber)) {
                             // Ø­Ø§Ù„Ø© Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø²ÙŠØ§Ø¯Ø©: Ø§Ù„Ù†Ø³Ø¨Ø© ØªÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                             // Ù…Ø«Ø§Ù„: 200000 - 10%  --> Ø§Ù„Ù€ 10% ØªØµØ¨Ø­ 20000
                             let percentValue = baseNumber * (currentVal / 100);
                             processedTokens.push(percentValue);
                        } else {
                            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: Ù…Ø¬Ø±Ø¯ Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ 100
                            // Ù…Ø«Ø§Ù„: 5000 * 50% --> ØªØ¹Ù†ÙŠ 5000 * 0.5
                            processedTokens.push(currentVal / 100);
                        }
                    } else {
                        processedTokens.push(tokens[i]);
                    }
                }
                tokens = processedTokens;

                // 3. Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ (ØªØ±Ø§ÙƒÙ…ÙŠ - Ù…Ø«Ù„ Ø¢Ù„Ø© Ø§Ù„Ù…Ø­Ù„)
                let result = 0;
                let currentOp = '+';
                let i = 0;

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„ (Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø§Ù„Ø¨Ø§Ù‹)
                if (tokens.length > 0 && !isNaN(parseFloat(tokens[0]))) {
                    result = parseFloat(tokens[0]);
                    i = 1;
                } else if (tokens.length > 1 && tokens[0] === '-' && !isNaN(parseFloat(tokens[1]))) {
                    result = -1 * parseFloat(tokens[1]);
                    i = 2;
                }

                // Ø­Ù„Ù‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
                while (i < tokens.length) {
                    let token = tokens[i];
                    
                    if (['+', '-', '*', '/'].includes(token)) {
                        currentOp = token;
                        if (i + 1 < tokens.length) {
                            let nextVal = parseFloat(tokens[i + 1]);
                            if (!isNaN(nextVal)) {
                                switch (currentOp) {
                                    case '+': result += nextVal; break;
                                    case '-': result -= nextVal; break;
                                    case '*': result *= nextVal; break;
                                    case '/': if(nextVal !== 0) result /= nextVal; break;
                                }
                                i++; 
                            }
                        }
                    } 
                    i++;
                }

                return result;
            } catch (e) {
                return 0;
            }
        }

        function calculate(isEqualPressed) {
            if (appMode === 'calc') {
                const inputEl = document.getElementById('val1');
                let rawInput = cleanString(inputEl.value);

                // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ---
                // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ø¹Ù„Ø§Ù…Ø© % Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø­Ø³Ø§Ø¨ØŒ ÙˆØ­Ø°Ù Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (+ - * /) ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ø³Ø·Ø±
                const lastChar = rawInput.slice(-1);
                if (['+','-','*','/'].includes(lastChar)) {
                    if (!isEqualPressed) return; 
                    rawInput = rawInput.slice(0, -1);
                }
                // -------------------

                let result = 0;

                if (isEqualPressed && isFinalState && lastRepeatedOp) {
                    let tempExpr = `${lastResultValue}${lastRepeatedOp.op}${lastRepeatedOp.val}`;
                    result = computeSequential(tempExpr);
                } else {
                    result = computeSequential(rawInput);
                    
                    if (isEqualPressed) {
                        // Ø­ÙØ¸ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ù„Ù„ØªÙƒØ±Ø§Ø±
                        // Ù†Ø³ØªØ®Ø¯Ù… regex ÙŠØ³ØªØ«Ù†ÙŠ Ø§Ù„Ù€ % Ù…Ù† ÙƒÙˆÙ†Ù‡ Ø¹Ù…Ù„ÙŠØ© "ØªÙƒØ±Ø§Ø±" ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                        const match = rawInput.match(/([\+\-\*\/])(\d+(\.\d+)?)$/);
                        if (match) {
                            lastRepeatedOp = { op: match[1], val: match[2] };
                        } else {
                            // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø¨Ù€ % Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø­ÙØ¸ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù„Ø£Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ… Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
                            lastRepeatedOp = null;
                        }
                    }
                }
                
                lastResultValue = result;

                // --- Currency Conversion ---
                const rate = parseFloat(document.getElementById('exchangeRate').value) || 1;
                let lbpVal = 0, usdVal = 0;
                let mainText = '', subText = '';

                if (activeCalcCurr === 'LBP') {
                    lbpVal = result; usdVal = result / rate;
                    mainText = formatReadable(lbpVal);
                    subText = formatReadable(usdVal) + ' $';
                } else {
                    usdVal = result; lbpVal = result * rate;
                    mainText = formatReadable(usdVal) + ' $';
                    subText = formatReadable(lbpVal) + ' L.L';
                }

                // Render
                const mainResEl = document.getElementById('mainResult');
                const subResEl = document.getElementById('subResult');
                fitText(mainResEl, mainText, true);
                fitText(subResEl, subText, false);

                if (isEqualPressed) {
                    addToHistory(rawInput, result, activeCalcCurr);
                    isFinalState = true;
                    document.getElementById('resultContainer').classList.add('final-state');
                } else {
                    isFinalState = false;
                    document.getElementById('resultContainer').classList.remove('final-state');
                }

            } else if (appMode === 'diff' && isEqualPressed && diffStep === 1) {
                let d = document.getElementById('val1').value;
                let m = document.getElementById('val2').value;
                let y = document.getElementById('val3').value;
                if(d && m && y) {
                    diffStart = new Date(parseInt(y), parseInt(m)-1, parseInt(d));
                    clearAll(false);
                    diffStep = 2;
                    setActiveInput('val1');
                    updateUI(true);
                }
            } else if (isEqualPressed) {
                updateUI(true);
            }
        }


        function liveCalculateOtherModes() {
            const v1 = cleanString(document.getElementById('val1').value);
            const v2 = cleanString(document.getElementById('val2').value);
            const v3 = cleanString(document.getElementById('val3').value);
            const mainRes = document.getElementById('mainResult');
            const subRes = document.getElementById('subResult');

            if (appMode === 'scale') {
                let w = parseFloat(v1) || 0; let p = parseFloat(v2) || 0;
                mainRes.innerText = formatReadable((w * p) / 1000);
                subRes.innerText = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ";
            } 
            else if (appMode === 'speed') {
                let s = parseFloat(v1) || 0; let t = parseFloat(v2) || 0;
                let distKM = 0;
                if(timeUnit === 'hour') distKM = s * t;
                else if(timeUnit === 'min') distKM = s * (t / 60);
                else distKM = s * (t / 3600);
                mainRes.innerText = formatReadable(distKM) + ' ÙƒÙ…';
                subRes.innerText = formatReadable(distKM * 1000) + ' Ù…ØªØ±';
            }
            else if (appMode === 'age' || appMode === 'diff') {
                let dateRes = null;
                if(appMode === 'age') dateRes = calculateAgeLogic(null, v1, v2, v3);
                else if (appMode === 'diff' && diffStep === 2) {
                     if(diffStart && v1 && v2 && v3.length===4) {
                         const d2 = new Date(parseInt(v3), parseInt(v2)-1, parseInt(v1));
                         let t1 = diffStart.getTime(); let t2 = d2.getTime();
                         let start = (t1 < t2) ? diffStart : d2; let end = (t1 < t2) ? d2 : diffStart;
                         let yy = end.getFullYear() - start.getFullYear();
                         let mm = end.getMonth() - start.getMonth();
                         let dd = end.getDate() - start.getDate();
                         if (dd < 0) { mm--; let pm = new Date(end.getFullYear(), end.getMonth(), 0); dd += pm.getDate(); }
                         if (mm < 0) { yy--; mm += 12; }
                         dateRes = { years: yy, months: mm, days: dd };
                    }
                }

                if (dateRes && !dateRes.error) {
                    mainRes.innerHTML = `
                        <div class="age-result-container">
                            <div class="age-box-res"><span class="age-num">${dateRes.years}</span><span class="age-txt">Ø³Ù†Ø©</span></div>
                            <div class="age-box-res"><span class="age-num">${dateRes.months}</span><span class="age-txt">Ø´Ù‡Ø±</span></div>
                            <div class="age-box-res"><span class="age-num">${dateRes.days}</span><span class="age-txt">ÙŠÙˆÙ…</span></div>
                        </div>`;
                    if(appMode === 'age') subRes.innerText = `Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø¨Ø¹Ø¯: ${dateRes.nextBirthday} ÙŠÙˆÙ… ğŸ‚`;
                    else subRes.innerText = "Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ";
                } else {
                    mainRes.innerText = '...';
                }
            }
        }

        function calculateAgeLogic(targetDate, dStr, mStr, yStr) {
            if(!dStr || !mStr || !yStr) return null;
            if(yStr.length < 4) return null;
            const d = parseInt(dStr); const m = parseInt(mStr); const y = parseInt(yStr);
            if(d>31 || m>12) return { error: 'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø®Ø·Ø£' };
            const birthDate = new Date(y, m - 1, d);
            const refDate = targetDate ? targetDate : new Date();
            let years = refDate.getFullYear() - birthDate.getFullYear();
            let months = refDate.getMonth() - birthDate.getMonth();
            let days = refDate.getDate() - birthDate.getDate();
            if (days < 0) { months--; const prev = new Date(refDate.getFullYear(), refDate.getMonth(), 0); days += prev.getDate(); }
            if (months < 0) { years--; months += 12; }
            let nextB = null;
            if(appMode === 'age') {
                const today = new Date();
                let next = new Date(today.getFullYear(), m - 1, d);
                if (today > next) next.setFullYear(today.getFullYear() + 1);
                const diffT = Math.abs(next - today);
                nextB = Math.ceil(diffT / (1000 * 60 * 60 * 24)); 
            }
            return { years: Math.abs(years), months: Math.abs(months), days: Math.abs(days), nextBirthday: nextB };
        }

        function fitText(el, text, isMain) {
            const len = text.length;
            let size = isMain ? 2.4 : 1.4;
            
            if(isFinalState) {
                size = isMain ? 2.8 : 1.6; 
                if (len > 10) size = isMain ? 2.2 : 1.3;
                if (len > 15) size = isMain ? 1.7 : 1.0;
                if (len > 22) size = isMain ? 1.3 : 0.8;
                if (len > 30) size = isMain ? 1.0 : 0.7;
            } else {
                if (len > 12) size = isMain ? 2.0 : 1.2;
                if (len > 18) size = isMain ? 1.6 : 1.0;
                if (len > 24) size = isMain ? 1.2 : 0.8;
                if (len > 32) size = isMain ? 1.0 : 0.7;
            }
            el.style.fontSize = size + 'rem';
            el.innerText = text;
        }

        function formatReadable(num) {
            if (num === undefined || num === null || isNaN(num)) return '0';
            let str = parseFloat(num.toFixed(10)).toLocaleString('en-US', { useGrouping: false });
            let parts = str.split('.');
            parts[0] = Number(parts[0]).toLocaleString('en-US');
            return parts[0] + (parts[1] ? '.' + parts[1].replace(/,/g, '') : '');
        }

        function switchMode(mode) {
            appMode = mode;
            clearAll(); 
            document.getElementById('toolsMenu').style.display = 'none';
            const box1 = document.getElementById('box1');
            const box2 = document.getElementById('box2');
            const box3 = document.getElementById('box3');
            const currBtn = document.getElementById('currencyToggleBtn');
            const label1 = document.getElementById('label1');

            if (mode === 'calc') {
                activeInputId = 'val1';
                box1.style.display = 'flex';
                box2.style.display = 'none';
                box3.style.display = 'none';
                currBtn.style.display = 'inline-block';
                label1.style.display = 'none';
                activeCalcCurr = 'LBP';
                currBtn.innerText = 'Ù„ÙŠØ±Ø© (L.L)';
            } else {
                box1.style.display = 'flex';
                box2.style.display = 'flex';
                currBtn.style.display = 'none';
                label1.style.display = 'block';
                activeInputId = 'val1';
            }
            setActiveInput(activeInputId);
            updateUI(false);
        }

        function toggleTools() {
            const menu = document.getElementById('toolsMenu');
            menu.style.display = (menu.style.display === 'grid') ? 'none' : 'grid';
        }

        function updateUI(reCalc) {
            const box1 = document.getElementById('box1'); const box2 = document.getElementById('box2'); const box3 = document.getElementById('box3');
            const btnEqual = document.getElementById('btnEqual');
            
            document.querySelectorAll('.tool-box').forEach(el => el.classList.remove('active'));
            if(appMode !== 'calc') document.getElementById('tool' + appMode.charAt(0).toUpperCase() + appMode.slice(1)).classList.add('active');
            
            btnEqual.innerText = '='; btnEqual.style.background = '';

            if (appMode === 'calc') {
                if(reCalc) calculate(false);
            } else if (appMode === 'scale') {
                box3.style.display = 'none';
                box2.style.display = 'flex'; 
                document.getElementById('label1').innerText = "Ø§Ù„ÙˆØ²Ù† (Øº)"; document.getElementById('label2').innerText = "Ø§Ù„Ø³Ø¹Ø± (Ù„Ù„ÙƒÙŠÙ„Ùˆ)";
                if(reCalc) liveCalculateOtherModes();
            } else if (appMode === 'speed') {
                box3.style.display = 'none';
                box2.style.display = 'flex';
                document.getElementById('label1').innerText = "Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ…/Ø³Ø§)"; 
                let unitT = "Ø«Ø§Ù†ÙŠØ©"; if(timeUnit==='min') unitT="Ø¯Ù‚ÙŠÙ‚Ø©"; if(timeUnit==='hour') unitT="Ø³Ø§Ø¹Ø©";
                document.getElementById('label2').innerText = "Ø§Ù„ÙˆÙ‚Øª (" + unitT + ") ğŸ”";
                if(reCalc) liveCalculateOtherModes();
            } else if (appMode === 'age' || appMode === 'diff') {
                box3.style.display = 'flex';
                box2.style.display = 'flex';
                document.getElementById('label1').innerText = "Ø§Ù„ÙŠÙˆÙ…"; document.getElementById('label2').innerText = "Ø§Ù„Ø´Ù‡Ø±"; document.getElementById('label3').innerText = "Ø§Ù„Ø³Ù†Ø©";
                if (appMode === 'diff') {
                    document.getElementById('subResult').innerText = diffStep === 1 ? "Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙˆÙ„ (1)" : "Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø«Ø§Ù†ÙŠ (2)";
                    btnEqual.innerText = diffStep === 1 ? "Ø§Ù„ØªØ§Ù„ÙŠ" : "=";
                    btnEqual.style.background = diffStep === 1 ? 'var(--blue-color)' : ''; 
                } else {
                    document.getElementById('subResult').innerText = "Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯Ùƒ";
                }
                if(reCalc) liveCalculateOtherModes();
            }
            saveState();
        }

        // --- History & Storage ---
        function openHistory() { 
            document.getElementById('toolsMenu').style.display = 'none';
            renderHistory(); 
            document.getElementById('historyModal').classList.add('show'); 
            history.pushState({modal:true},null,location.href); 
        }
        function openRate() { document.getElementById('rateModal').classList.add('show'); history.pushState({modal:true},null,location.href); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }
        function clearHistory() { historyData=[]; saveState(); renderHistory(); }

        function addToHistory(eq, res, curr) {
            if(!eq || res === 0) return;
            const time = new Date().toLocaleTimeString('ar-LB',{hour:'2-digit',minute:'2-digit'});
            historyData.unshift({ eq, res, curr, time });
            if(historyData.length > 30) historyData.pop();
            saveState();
        }
        function renderHistory() {
            const list = document.getElementById('historyList'); list.innerHTML = '';
            if (appMode !== 'calc') { list.innerHTML = '<li style="text-align:center; padding:10px; color:#999">Ø§Ù„Ø³Ø¬Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙÙ‚Ø·</li>'; return; }
            historyData.forEach(item => {
                const li = document.createElement('li'); li.className = 'history-item';
                let vEq = item.eq.replace(/\*/g,'Ã—').replace(/\//g,'Ã·');
                li.innerHTML = `<div style="font-size:0.8rem; direction:ltr">${vEq}</div><div style="font-weight:bold; color:var(--blue-color); direction:ltr">= ${formatReadable(item.res)} ${item.curr==='LBP'?'': '$'}</div>`;
                li.onclick = () => { 
                    closeModals();
                    activeCalcCurr = item.curr;
                    document.getElementById('currencyToggleBtn').innerText = (item.curr === 'LBP') ? 'Ù„ÙŠØ±Ø© (L.L)' : 'Ø¯ÙˆÙ„Ø§Ø± ($)';
                    document.getElementById('val1').value = formatString(item.eq); 
                    calculate(true); 
                };
                list.appendChild(li);
            });
        }

        function saveState() {
            localStorage.setItem('rate', document.getElementById('exchangeRate').value);
            localStorage.setItem('hist', JSON.stringify(historyData));
        }
        function loadState() {
            if(localStorage.getItem('rate')) document.getElementById('exchangeRate').value = localStorage.getItem('rate');
            if(localStorage.getItem('hist')) historyData = JSON.parse(localStorage.getItem('hist'));
        }

        document.getElementById('exchangeRate').addEventListener('input', () => { updateUI(true); saveState(); });
        document.getElementById('btnSaveRate').addEventListener('click', closeModals);

        // --- KODULAR INTEGRATION ---
        function handleAndroidBack() {
            if(document.querySelector('.modal.show')) {
                closeModals();
                sendToKodular("STAY");
                return;
            }
            if(document.getElementById('toolsMenu').style.display === 'grid') {
                toggleTools();
                sendToKodular("STAY");
                return;
            }
            if(appMode !== 'calc') {
                switchMode('calc');
                sendToKodular("STAY");
                return;
            }
            sendToKodular("EXIT");
        }

        function sendToKodular(message) {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(message);
            }
        }
        
    </script>
</body>
</html>
