<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>آلة حاسبة</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

        :root {
            --header-bg: #333333;
            --bg-color: #ffffff;
            --btn-text-blue: #2962ff;
            --btn-bg-equal: #3955bc;
            --border-color: #f0f0f0;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Tajawal', sans-serif;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
        }

        /* --- 1. Header --- */
        .top-header {
            background-color: var(--header-bg);
            color: white;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
            direction: ltr; 
        }
        
        .header-title { font-size: 1.1rem; font-weight: 500; }
        .header-icons { display: flex; gap: 20px; font-size: 1.3rem; cursor: pointer; color: #fff; }

        /* --- 2. Display --- */
        .display-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px 20px;
            background: #ffffff;
            overflow: hidden;
        }

        .result-line {
            text-align: right;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .main-res { font-size: 2.2rem; font-weight: bold; color: #333; direction: ltr; }
        .sub-res { font-size: 1.1rem; color: #888; direction: ltr; margin-top: 5px; }

        .inputs-wrapper {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            direction: rtl; 
        }
        .curr-box {
            flex: 1;
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 5px;
            text-align: right;
        }
        .curr-box.active { border-color: var(--btn-text-blue); background: #f9fbff; }
        .curr-label { font-size: 0.8rem; color: #666; font-weight: bold; }
        .curr-val { font-size: 1.1rem; font-weight: 600; direction: ltr; overflow: hidden; white-space: nowrap; }

        /* --- 3. Middle Toolbar --- */
        .middle-toolbar {
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
            flex-shrink: 0;
            direction: ltr; 
        }

        .tool-icon {
            font-size: 1.5rem;
            color: var(--btn-text-blue);
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 2px;
        }

        .backspace-btn {
            width: 40px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .bs-icon {
            background-color: var(--btn-bg-equal);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            position: relative;
            margin-left: 10px; 
        }
        
        .bs-icon::before {
            content: '';
            position: absolute;
            left: -8px; 
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid var(--btn-bg-equal);
        }

        /* --- 4. Keypad --- */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background-color: #fff;
            height: 60%; 
            max-height: 400px;
            flex-shrink: 0;
            border-top: 1px solid #e0e0e0;
            direction: ltr; 
        }

        .k-btn {
            background: #fff;
            border: none;
            border-right: 1px solid #f5f5f5; 
            border-bottom: 1px solid #f5f5f5;
            font-size: 1.8rem;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            outline: none;
        }

        .k-btn:active { background-color: #f0f0f0; }
        .txt-blue { color: var(--btn-text-blue); font-size: 1.6rem; }
        .bg-blue { background-color: var(--btn-bg-equal); color: white; font-size: 2.2rem; }
        .bg-blue:active { background-color: #2c4296; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
            direction: rtl; 
        }
        .modal.show { display: flex; }
        .modal-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 8px; padding: 20px; max-height: 80vh;
            display: flex; flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .rate-group input {
            width: 100%; border: 1px solid #ddd; padding: 10px;
            font-size: 1.2rem; margin: 10px 0; text-align: center;
            border-radius: 4px; color: var(--btn-text-blue); font-weight: bold;
        }
        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; max-height: 300px; padding-top:10px;}
        .history-item { 
            padding: 10px; border-bottom: 1px solid #f1f1f1; 
            display: flex; justify-content: space-between; align-items: center;
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Header -->
        <div class="top-header">
            <div class="header-icons">
                <span onclick="openMenu()">&#9776;</span> 
                <span onclick="openMenu()" style="font-size:1.2rem">↺</span>
            </div>
            <div class="header-title">آلة حاسبة</div>
        </div>

        <!-- Display -->
        <div class="display-area">
            <div class="result-line">
                <div class="main-res" id="mainResult">0</div>
                <div class="sub-res" id="subResult">0 $</div>
            </div>

            <div class="inputs-wrapper">
                <div class="curr-box active" id="lbpBox" onclick="setActiveInput('LBP')">
                    <div class="curr-label">ليرة</div>
                    <div class="curr-val" id="lbpInputDisplay"></div>
                </div>
                <div class="curr-box" id="usdBox" onclick="setActiveInput('USD')">
                    <div class="curr-label">دولار</div>
                    <div class="curr-val" id="usdInputDisplay"></div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="middle-toolbar">
            <div style="display:flex; gap:20px;">
                <span class="tool-icon" onclick="openMenu()">...</span>
                <span class="tool-icon" style="font-size:1.2rem">^</span>
            </div>
            
            <div class="backspace-btn" onclick="deleteChar()">
                <div class="bs-icon">✕</div>
            </div>
        </div>

        <!-- Keypad -->
        <div class="keypad">
            <!-- Row 1 -->
            <button class="k-btn txt-blue" onclick="clearAll()">C</button>
            <button class="k-btn txt-blue" onclick="appendParens()">()</button>
            <button class="k-btn txt-blue" onclick="appendOperator('%')">%</button>
            <button class="k-btn txt-blue" style="font-size:2rem" onclick="appendOperator('/')">÷</button>

            <!-- Row 2 -->
            <button class="k-btn" onclick="appendNumber('7')">7</button>
            <button class="k-btn" onclick="appendNumber('8')">8</button>
            <button class="k-btn" onclick="appendNumber('9')">9</button>
            <button class="k-btn txt-blue" style="font-size:2rem" onclick="appendOperator('*')">×</button>

            <!-- Row 3 -->
            <button class="k-btn" onclick="appendNumber('4')">4</button>
            <button class="k-btn" onclick="appendNumber('5')">5</button>
            <button class="k-btn" onclick="appendNumber('6')">6</button>
            <button class="k-btn txt-blue" style="font-size:2rem" onclick="appendOperator('-')">-</button>

            <!-- Row 4 -->
            <button class="k-btn" onclick="appendNumber('1')">1</button>
            <button class="k-btn" onclick="appendNumber('2')">2</button>
            <button class="k-btn" onclick="appendNumber('3')">3</button>
            <button class="k-btn txt-blue" style="font-size:2rem" onclick="appendOperator('+')">+</button>

            <!-- Row 5 -->
            <button class="k-btn" onclick="appendNumber('0')">0</button>
            <button class="k-btn" onclick="appendNumber('00')">00</button>
            <button class="k-btn" onclick="appendNumber('.')">,</button>
            <button class="k-btn bg-blue" onclick="calculate(true)">=</button>
        </div>

    </div>

    <!-- Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold">الإعدادات</span>
                <span onclick="closeMenu()" style="cursor:pointer">✕</span>
            </div>
            
            <label style="font-size:0.9rem; color:#666">سعر الصرف:</label>
            <div class="rate-group">
                <input type="number" id="exchangeRate" value="89000" placeholder="سعر الصرف">
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <span style="font-weight:bold">السجل</span>
                <span style="color:red; font-size:0.8rem; cursor:pointer" onclick="clearHistory()">مسح</span>
            </div>
            <ul id="historyList" class="history-list"></ul>
        </div>
    </div>

    <script>
        let currentInput = '';
        let activeCurrency = 'LBP'; 
        let historyData = [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(600, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.04);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.05);
        }

        window.onload = () => { loadState(); updateUI(); history.pushState(null,null,location.href); };

        function setActiveInput(curr) {
            playSound();
            activeCurrency = curr;
            document.getElementById('lbpBox').className = `curr-box ${curr==='LBP'?'active':''}`;
            document.getElementById('usdBox').className = `curr-box ${curr==='USD'?'active':''}`;
            updateUI();
        }

        function appendNumber(n) {
            playSound();
            if (currentInput === '0' && n !== '.') {
                if(n === '00') currentInput = '0';
                else currentInput = n;
            } else {
                currentInput += n;
            }
            updateUI();
        }

        function appendOperator(op) {
            playSound();
            const last = currentInput.slice(-1);
            if(['+','-','*','/','%','.'].includes(last)) currentInput = currentInput.slice(0,-1)+op;
            else currentInput += op;
            updateUI();
        }

        function appendParens() {
            playSound();
            const openCount = (currentInput.match(/\(/g) || []).length;
            const closeCount = (currentInput.match(/\)/g) || []).length;
            const last = currentInput.slice(-1);
            if (openCount > closeCount && ['0','1','2','3','4','5','6','7','8','9',')'].includes(last)) {
                currentInput += ')';
            } else {
                if (['0','1','2','3','4','5','6','7','8','9'].includes(last)) currentInput += '*(';
                else currentInput += '(';
            }
            updateUI();
        }

        function deleteChar() { playSound(); currentInput = currentInput.toString().slice(0,-1); updateUI(); }
        function clearAll() { playSound(); currentInput = ''; updateUI(); }

        function calculate(saveToHistory) {
            if(saveToHistory) playSound();
            if(!currentInput) return;
            try {
                let rawRes = eval(currentInput);
                if(saveToHistory) addToHistory(currentInput, rawRes, activeCurrency);
                saveState();
            } catch (e) {}
        }

        function formatReadable(num) {
            if (num === undefined || num === null) return '0';
            let str = num.toLocaleString('en-US', { maximumFractionDigits: 12, useGrouping: false });
            let parts = str.split('.');
            parts[0] = Number(parts[0]).toLocaleString('en-US');
            if (parts[1]) {
                parts[1] = parts[1].match(/.{1,3}/g).join(',');
            }
            return parts.join('.');
        }

        function updateUI() {
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 1;
            
            let visualEq = currentInput.replace(/\*/g,'×').replace(/\//g,'÷');
            visualEq = visualEq.replace(/\d+/g, (n) => Number(n).toLocaleString('en-US'));

            const lbpIn = document.getElementById('lbpInputDisplay');
            const usdIn = document.getElementById('usdInputDisplay');

            if(activeCurrency === 'LBP') {
                lbpIn.innerText = visualEq || '0';
                usdIn.innerText = '---';
            } else {
                usdIn.innerText = visualEq || '0';
                lbpIn.innerText = '---';
            }

            let resultVal = 0;
            try {
                let clean = currentInput;
                if(['+','-','*','/','%','('].includes(clean.slice(-1))) clean = clean.slice(0,-1);
                resultVal = clean ? eval(clean) : 0;
            } catch { resultVal = 0; }

            const mainRes = document.getElementById('mainResult');
            const subRes = document.getElementById('subResult');

            if(activeCurrency === 'LBP') {
                mainRes.innerText = formatReadable(resultVal); // حذف كلمة ليرة هنا
                subRes.innerText = formatReadable(resultVal / rate) + ' $';
            } else {
                mainRes.innerText = formatReadable(resultVal) + ' $';
                subRes.innerText = formatReadable(resultVal * rate); // حذف كلمة ليرة هنا
            }
            saveState();
        }

        function addToHistory(eq, res, curr) {
            const time = new Date().toLocaleTimeString('ar-LB',{hour:'2-digit',minute:'2-digit'});
            const item = { eq, res, curr, time };
            historyData.unshift(item);
            if(historyData.length > 30) historyData.pop();
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            historyData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                let vEq = item.eq.replace(/\*/g,'×').replace(/\//g,'÷');
                const sym = item.curr==='LBP'?'':'$'; // تم إزالة كلمة ليرة من السجل أيضاً للتناسق
                li.innerHTML = `
                    <div style="font-size:0.8rem; direction:ltr">${vEq}</div>
                    <div style="font-weight:bold; color:#2962ff; direction:ltr">= ${formatReadable(item.res)} ${sym}</div>
                `;
                li.onclick = () => {
                    currentInput = item.eq; 
                    setActiveInput(item.curr);
                    closeMenu();
                };
                list.appendChild(li);
            });
        }

        function openMenu() { renderHistory(); document.getElementById('menuModal').classList.add('show'); history.pushState({modal:true},null,location.href); }
        function closeMenu() { document.getElementById('menuModal').classList.remove('show'); }
        function clearHistory() { historyData=[]; saveState(); renderHistory(); }

        function saveState() {
            localStorage.setItem('z_rate', document.getElementById('exchangeRate').value);
            localStorage.setItem('z_in', currentInput);
            localStorage.setItem('z_curr', activeCurrency);
            localStorage.setItem('z_hist', JSON.stringify(historyData));
        }
        function loadState() {
            if(localStorage.getItem('z_rate')) document.getElementById('exchangeRate').value = localStorage.getItem('z_rate');
            if(localStorage.getItem('z_in')) currentInput = localStorage.getItem('z_in');
            if(localStorage.getItem('z_curr')) setActiveInput(localStorage.getItem('z_curr'));
            if(localStorage.getItem('z_hist')) historyData = JSON.parse(localStorage.getItem('z_hist'));
        }

        window.addEventListener('popstate', ()=>{
            history.pushState(null,null,location.href);
            if(document.getElementById('menuModal').classList.contains('show')) closeMenu();
            else if(currentInput.length>0) deleteChar();
        });
        document.getElementById('exchangeRate').addEventListener('input', () => { updateUI(); saveState(); });
        document.querySelectorAll('button').forEach(b=>{
            b.addEventListener('touchstart',function(){this.style.backgroundColor='#eee'});
            b.addEventListener('touchend',function(){this.style.backgroundColor='var(--btn-bg)'});
        });
        document.querySelector('.bg-blue').addEventListener('touchstart',function(){this.style.backgroundColor='#2c4296'});
        document.querySelector('.bg-blue').addEventListener('touchend',function(){this.style.backgroundColor='var(--btn-bg-equal)'});

    </script>
</body>
</html>