<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الحاسبة الذكية</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');

        :root {
            --bg-color: #f1f3f6;
            --card-bg: #ffffff;
            --text-color: #2d3436;
            --accent-color: #2962ff;
            --accent-hover: #0d47a1;
            --result-bg: #2d3436;
            --result-text: #ffffff;
            --btn-bg: #ffffff;
            --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-btn: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Tajawal', sans-serif;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 6px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* --- 1. Top Bar --- */
        .top-bar {
            display: flex;
            justify-content: flex-end;
            padding: 0 5px;
            margin-bottom: 5px;
            height: 30px;
        }
        .menu-btn {
            background: none; border: none; font-size: 1.5rem; color: #636e72; cursor: pointer;
        }

        /* --- 2. Result Screen --- */
        .result-card {
            background: var(--result-bg);
            color: var(--result-text);
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            height: 85px; 
            flex-shrink: 0;
        }
        
        .main-result {
            font-size: 1.6rem;
            font-weight: 800;
            width: 100%;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            direction: ltr;
        }
        
        .sub-result {
            font-size: 0.9rem;
            opacity: 0.8;
            width: 100%;
            text-align: right;
            direction: ltr;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        /* --- 3. Input Screens --- */
        .screens-wrapper {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .screen-box {
            background: var(--card-bg);
            flex: 1;
            padding: 8px;
            border-radius: 10px;
            box-shadow: var(--shadow-soft);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            height: 60px;
            cursor: pointer;
            position: relative;
        }

        .screen-box.active { border-color: var(--accent-color); background-color: #fbfdff; }
        .box-label { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
        .box-value {
            font-size: 1rem;
            font-weight: 600; color: #2d3436;
            direction: ltr; text-align: right;
            white-space: nowrap; overflow: hidden;
        }

        /* --- 4. Keypad --- */
        .keypad-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 0;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 6px;
            flex-grow: 1;
            direction: ltr;
        }

        .btn {
            background: var(--btn-bg);
            border-radius: 8px;
            border: none;
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3436;
            box-shadow: var(--shadow-btn);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; padding: 0;
        }
        .btn:active { background: #eee; }
        .btn-op { color: var(--accent-color); background-color: #f8f9fa; font-size: 1.5rem; }
        .btn-del { color: #e74c3c; font-size: 1.2rem; }

        .btn-confirm {
            background: var(--accent-color);
            color: white;
            font-size: 2rem;
            border-radius: 10px;
            height: 55px;
            box-shadow: 0 4px 10px rgba(41, 98, 255, 0.3);
            border: none; width: 100%; flex-shrink: 0;
        }
        .btn-confirm:active { background: var(--accent-hover); }

        /* --- Modal --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal.show { display: flex; }
        .modal-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 16px; padding: 20px; max-height: 80vh;
            display: flex; flex-direction: column;
        }
        
        .modal-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        .rate-group {
            background: #f1f3f6; padding: 10px; border-radius: 10px;
            margin-bottom: 15px; text-align: center;
        }
        .rate-label { font-size: 0.9rem; color: #636e72; margin-bottom: 5px; display: block; }
        .rate-input {
            width: 100%; border: none; background: transparent;
            font-size: 1.5rem; font-weight: bold; color: var(--accent-color);
            text-align: center; outline: none;
        }

        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; border-top: 1px solid #eee; padding-top: 10px; }
        .history-item { 
            padding: 10px; border-bottom: 1px solid #f1f1f1; 
            display: flex; flex-direction: column; gap: 4px;
        }
        .h-eq { font-size: 0.85rem; color: #666; direction: ltr; text-align: left; }
        .h-res { font-size: 1rem; font-weight: bold; color: var(--accent-color); direction: ltr; text-align: left;}

    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="top-bar">
            <button class="menu-btn" onclick="openMenu()">&#8942;</button>
        </div>

        <!-- Result Screen -->
        <div class="result-card">
            <div class="main-result" id="mainResult">0</div>
            <div class="sub-result" id="subResult">0 $</div>
        </div>

        <!-- Input Screens -->
        <div class="screens-wrapper">
            <div class="screen-box active" id="lbpBox" onclick="setActiveInput('LBP')">
                <span class="box-label">ليرة (عملية)</span>
                <div class="box-value" id="lbpInputDisplay"></div>
            </div>

            <div class="screen-box" id="usdBox" onclick="setActiveInput('USD')">
                <span class="box-label">دولار (عملية)</span>
                <div class="box-value" id="usdInputDisplay"></div>
            </div>
        </div>

        <!-- Keypad -->
        <div class="keypad-container">
            <div class="main-grid">
                <button class="btn btn-del" onclick="clearAll()">AC</button>
                <button class="btn btn-del" onclick="deleteChar()">⌫</button>
                <button class="btn btn-op" onclick="appendOperator('%')">%</button>
                <button class="btn btn-op" onclick="appendOperator('/')">÷</button>
                
                <button class="btn" onclick="appendNumber('7')">7</button>
                <button class="btn" onclick="appendNumber('8')">8</button>
                <button class="btn" onclick="appendNumber('9')">9</button>
                <button class="btn btn-op" onclick="appendOperator('*')">×</button>
                
                <button class="btn" onclick="appendNumber('4')">4</button>
                <button class="btn" onclick="appendNumber('5')">5</button>
                <button class="btn" onclick="appendNumber('6')">6</button>
                <button class="btn btn-op" onclick="appendOperator('-')">-</button>
                
                <button class="btn" onclick="appendNumber('1')">1</button>
                <button class="btn" onclick="appendNumber('2')">2</button>
                <button class="btn" onclick="appendNumber('3')">3</button>
                <button class="btn btn-op" onclick="appendOperator('+')">+</button>
                
                <button class="btn" onclick="appendNumber('0')">0</button>
                <button class="btn" onclick="appendNumber('00')">00</button>
                <button class="btn" onclick="appendNumber('000')">000</button>
                <button class="btn" onclick="appendNumber('.')">.</button>
            </div>
            
            <button class="btn btn-confirm" onclick="calculate(true)">=</button>
        </div>

    </div>

    <!-- Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-card">
            <div class="modal-title">
                <span>الإعدادات والمحفوظات</span>
                <span onclick="closeMenu()" style="cursor:pointer">✕</span>
            </div>
            
            <div class="rate-group">
                <label class="rate-label">سعر الصرف الحالي</label>
                <input type="number" id="exchangeRate" class="rate-input" value="11500" placeholder="ادخل السعر">
            </div>

            <h4 style="margin:5px 0; color:#444">آخر العمليات:</h4>
            <ul id="historyList" class="history-list">
                <!-- Items -->
            </ul>
            <button class="btn" style="background:#ffebee; color:#d32f2f; margin-top:10px; font-size:1rem;" onclick="clearHistory()">مسح السجل</button>
        </div>
    </div>

    <script>
        let currentInput = '';
        let activeCurrency = 'LBP'; 
        let historyData = [];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(600, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.1);
        }

        window.onload = () => { loadState(); updateUI(); history.pushState(null,null,location.href); };

        function setActiveInput(curr) {
            playSound();
            activeCurrency = curr;
            document.getElementById('lbpBox').className = `screen-box ${curr==='LBP'?'active':''}`;
            document.getElementById('usdBox').className = `screen-box ${curr==='USD'?'active':''}`;
            updateUI();
        }

        // --- FIX: Prevent leading Zero issue (02000) ---
        function appendNumber(n) {
            playSound();
            // اذا كان الرقم الحالي صفر فقط، والرقم الجديد ليس نقطة، استبدل الصفر بالرقم الجديد
            if (currentInput === '0' && n !== '.') {
                if(n === '00' || n === '000') {
                    // اذا كان صفر وضغطت 00 يبقى صفر
                    currentInput = '0';
                } else {
                    currentInput = n;
                }
            } else {
                currentInput += n;
            }
            updateUI();
        }

        function appendOperator(op) {
            playSound();
            const last = currentInput.slice(-1);
            if(['+','-','*','/','%','.'].includes(last)) currentInput = currentInput.slice(0,-1)+op;
            else currentInput += op;
            updateUI();
        }
        function deleteChar() { playSound(); currentInput = currentInput.toString().slice(0,-1); updateUI(); }
        function clearAll() { playSound(); currentInput = ''; updateUI(); }

        function calculate(saveToHistory) {
            if(saveToHistory) playSound();
            if(!currentInput) return;
            try {
                let rawRes = eval(currentInput);
                if(saveToHistory) addToHistory(currentInput, rawRes, activeCurrency);
                saveState();
            } catch (e) {}
        }

        // Formatter with commas everywhere
        function formatReadable(num) {
            if (num === undefined || num === null) return '0';
            let str = num.toLocaleString('en-US', { maximumFractionDigits: 12, useGrouping: false });
            let parts = str.split('.');
            parts[0] = Number(parts[0]).toLocaleString('en-US');
            if (parts[1]) {
                parts[1] = parts[1].match(/.{1,3}/g).join(',');
            }
            return parts.join('.');
        }

        function updateUI() {
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 1;
            
            // Equation Display
            let visualEq = currentInput.replace(/\*/g,'×').replace(/\//g,'÷');
            visualEq = visualEq.replace(/\d+/g, (n) => Number(n).toLocaleString('en-US'));

            const lbpIn = document.getElementById('lbpInputDisplay');
            const usdIn = document.getElementById('usdInputDisplay');

            if(activeCurrency === 'LBP') {
                lbpIn.innerText = visualEq || '0';
                usdIn.innerText = '---';
            } else {
                usdIn.innerText = visualEq || '0';
                lbpIn.innerText = '---';
            }

            // Result Calc
            let resultVal = 0;
            try {
                let clean = currentInput;
                if(['+','-','*','/','%'].includes(clean.slice(-1))) clean = clean.slice(0,-1);
                resultVal = clean ? eval(clean) : 0;
            } catch { resultVal = 0; }

            const mainRes = document.getElementById('mainResult');
            const subRes = document.getElementById('subResult');

            if(activeCurrency === 'LBP') {
                mainRes.innerText = formatReadable(resultVal) + ' L.L';
                subRes.innerText = formatReadable(resultVal / rate) + ' $';
            } else {
                mainRes.innerText = formatReadable(resultVal) + ' $';
                subRes.innerText = formatReadable(resultVal * rate) + ' L.L';
            }
            
            saveState();
        }

        function addToHistory(eq, res, curr) {
            const time = new Date().toLocaleTimeString('ar-LB',{hour:'2-digit',minute:'2-digit'});
            const item = { eq, res, curr, time };
            historyData.unshift(item);
            if(historyData.length > 30) historyData.pop();
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if(!historyData.length) {
                list.innerHTML = '<li style="text-align:center;color:#999;padding:10px">لا يوجد بيانات</li>';
                return;
            }
            historyData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                const currLabel = item.curr === 'LBP' ? 'ليرة' : '$';
                let vEq = item.eq.replace(/\*/g,'×').replace(/\//g,'÷');
                li.innerHTML = `
                    <div class="h-eq">${vEq} (${currLabel})</div>
                    <div class="h-res">= ${formatReadable(item.res)}</div>
                `;
                li.onclick = () => {
                    currentInput = item.eq; 
                    setActiveInput(item.curr);
                    closeMenu();
                };
                list.appendChild(li);
            });
        }

        function openMenu() {
            renderHistory();
            document.getElementById('menuModal').classList.add('show');
            history.pushState({modal:true},null,location.href);
        }
        function closeMenu() { document.getElementById('menuModal').classList.remove('show'); }
        function clearHistory() { historyData=[]; saveState(); renderHistory(); }

        function saveState() {
            localStorage.setItem('x_rate', document.getElementById('exchangeRate').value);
            localStorage.setItem('x_in', currentInput);
            localStorage.setItem('x_curr', activeCurrency);
            localStorage.setItem('x_hist', JSON.stringify(historyData));
        }
        function loadState() {
            if(localStorage.getItem('x_rate')) document.getElementById('exchangeRate').value = localStorage.getItem('x_rate');
            if(localStorage.getItem('x_in')) currentInput = localStorage.getItem('x_in');
            if(localStorage.getItem('x_curr')) setActiveInput(localStorage.getItem('x_curr'));
            if(localStorage.getItem('x_hist')) historyData = JSON.parse(localStorage.getItem('x_hist'));
        }

        window.addEventListener('popstate', ()=>{
            history.pushState(null,null,location.href);
            if(document.getElementById('menuModal').classList.contains('show')) closeMenu();
            else if(currentInput.length>0) deleteChar();
        });
        document.getElementById('exchangeRate').addEventListener('input', () => { updateUI(); saveState(); });
        document.querySelectorAll('.btn').forEach(b=>{
            b.addEventListener('touchstart',function(){this.style.background='#eee'});
            b.addEventListener('touchend',function(){this.style.background='var(--btn-bg)'});
        });
        document.querySelector('.btn-confirm').addEventListener('touchend',function(){this.style.background='var(--accent-color)'});

    </script>
</body>
</html>